name: Contributor Lifecycle Messages

on:
  pull_request_target:
    types: [closed]

permissions:
  contents: read
  pull-requests: write

jobs:
  contributor-messages:
    if: github.event.pull_request.merged == true && github.event.pull_request.user.type != 'Bot'
    runs-on: ubuntu-latest
    steps:
      - name: Post onboarding/retention message
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const username = context.payload.pull_request.user.login;
            const prNumber = context.payload.pull_request.number;

            const pulls = await github.paginate(github.rest.pulls.list, {
              owner,
              repo,
              state: 'closed',
              per_page: 100,
            });

            const mergedByUser = pulls.filter((pr) =>
              pr.merged_at && pr.user && pr.user.login === username
            );

            const mergedCount = mergedByUser.length;
            let body = null;

            if (mergedCount === 1) {
              body = [
                `Hi @${username},`,
                '',
                'Welcome officially to RapidKit ðŸš€',
                '',
                'To help you get started smoothly, here are a few recommended first steps:',
                '',
                '- Review the project README and contribution guidelines',
                '- Explore open issues and choose one that matches your interests or experience level',
                '- Comment on the issue before starting work so maintainers can support and align with you',
                '',
                'If you have ideas, improvements, or questions, feel free to open a discussion anytime â€” contributor feedback is an important part of RapidKitâ€™s evolution.',
                '',
                'Weâ€™re excited to collaborate with you and look forward to your first contribution.',
                '',
                'Best regards,',
                'The RapidKit Team',
              ].join('\n');
            } else if (mergedCount === 3) {
              body = [
                `Hi @${username},`,
                '',
                'We wanted to take a moment to thank you for your continued contributions to RapidKit.',
                '',
                'Your involvement is helping shape the future of the project, and we truly value your consistency and collaboration within the community.',
                '',
                'As you continue contributing, youâ€™re welcome to participate in architectural discussions, propose improvements, or take ownership of areas that interest you.',
                '',
                'Weâ€™re glad to have you as part of the RapidKit ecosystem ðŸš€',
                '',
                'Best regards,',
                'The RapidKit Team',
              ].join('\n');
            }

            if (!body) {
              core.info(`No lifecycle message for mergedCount=${mergedCount}`);
              return;
            }

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body,
            });
